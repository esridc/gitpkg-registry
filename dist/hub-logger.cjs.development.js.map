{"version":3,"file":"hub-logger.cjs.development.js","sources":["../src/index.ts"],"sourcesContent":["// eslint-disable-next-line @typescript-eslint/no-var-requires\nconst winston = require('winston');\n\n/**\n * log level\n */\nexport type LogLevel = 'error' | 'warn' | 'info' | 'debug';\n\n/**\n * log data\n */\nexport type LogData = {\n  [label: string]: string | number | boolean | undefined;\n};\n\n/**\n * Hub logger options\n */\nexport interface IHubLoggerOptions {\n  /**\n   * Minimal log level. Default to info.\n   */\n  level?: LogLevel;\n  /**\n   * Global log labels that will be added into every log message\n   */\n  labels?: LogData;\n  /**\n   * Size limit (bytes) for a single log message. Default to 200 KB. To disable the\n   * auto-truncation for oversized messages, set this limit to Infinit.\n   */\n  sizeLimit?: number;\n}\n\nexport class HubLogger {\n  winstonLogger: any;\n  sizeLimit: number;\n  globalLabels: LogData;\n\n  constructor(options: IHubLoggerOptions = {}) {\n    this.sizeLimit = this.getSizeLimit(options.sizeLimit)\n    this.globalLabels = options.labels ?? {};\n\n    const consoleTransport = new winston.transports.Console({\n      level: options.level || 'info',\n      format: winston.format.printf(\n        (data: { message: string }) => data.message\n      ),\n      // handle uncaught node exceptions\n      handleExceptions: true,\n      // handle uncaught promise rejections\n      handleRejections: true,\n    });\n\n    this.winstonLogger = winston.createLogger({\n      transports: [consoleTransport],\n    });\n  }\n\n  private log(level: LogLevel, status: string, data?: LogData): void {\n    const timestamp = new Date()\n    let formatted: string = formatLog(\n      level,\n      timestamp,\n      status,\n      Object.assign({}, this.globalLabels, data)\n    );\n\n    if (formatted.length > this.sizeLimit) {\n      this.warn('oversize-log-truncated', { \n        timestamp: timestamp.toISOString()\n      })\n\n      formatted = `TOO LONG TRUNCATED ${formatted.slice(\n        0,\n        this.sizeLimit\n      )}`.trim();\n    }\n\n    this.winstonLogger[level](formatted);\n  }\n\n  private getSizeLimit (sizeLimit?: number): number {\n    const lowerLimit = 100\n    const upperLimit = 200 * 1000 // 200 KB\n\n    sizeLimit = sizeLimit ?? upperLimit\n\n    if (sizeLimit < lowerLimit) {\n      // apply a lower limit to avoid truncating any meaningful information\n      return lowerLimit\n    } else if (sizeLimit > upperLimit) {\n      // apply a upper limit to satisfy AWS CloudWatch log size limit\n      return upperLimit\n    } else {\n      return sizeLimit\n    }\n  }\n\n  /**\n   * Print a info-level log.\n   * @param status log status string\n   * @param data log data\n   */\n  info(status: string, data?: LogData): void {\n    this.log('info', status, data);\n  }\n\n  /**\n   * Print a debug-level log.\n   * @param status log status string\n   * @param data log data\n   */\n  debug(status: string, data?: LogData): void {\n    this.log('debug', status, data);\n  }\n\n  /**\n   * Print a warn-level log.\n   * @param status log status string\n   * @param data log data\n   */\n  warn(status: string, data?: LogData): void {\n    this.log('warn', status, data);\n  }\n\n  /**\n   * Print an error-level log.\n   * @param status log status string\n   * @param dataOrError log data or an Error object\n   */\n  error(status: string, dataOrError?: LogData | Error): void {\n    let data: LogData | undefined;\n\n    if (dataOrError instanceof Error) {\n      const error = dataOrError as Error;\n\n      data = {\n        errorName: error.name,\n        errorMessage: error.message,\n      };\n\n      if (error.stack) {\n        data.source = getErrorSource(error.stack);\n      }\n    } else {\n      data = dataOrError;\n    }\n\n    this.log('error', status, data);\n  }\n}\n\n/**\n * Find out the problematic line in the source code by analyzing the error stack.\n * @param trace Error stack trace\n * @returns the path of the problematic file and the line number\n * @example 'at request (/opt/my-service/utils/request.js:91:23)'\n */\nexport function getErrorSource(trace = ''): string {\n  const filenameAndLineNumber = /(.+?\\.js):(\\d+):\\d+/;\n  const line =\n    trace.split('\\n').find(line => filenameAndLineNumber.test(line)) || '';\n  return line.trim();\n}\n\n/**\n * Format log parameters into a log string. This method accepts the same parameters as the ones for\n * the logger methods and can be used to generate log message for testing.\n * @param level log level\n * @param timestamp\n * @param status log status\n * @param data optional log data\n * @returns an one-line log string\n * @example 'level=\"info\" status=\"http-request-succeed\" timestamp=\"...\"'\n */\nexport function formatLog(level: LogLevel, timestamp: Date, status: string, data: LogData = {}) {\n  return (\n    Object.entries({\n      level,\n      timestamp: timestamp.toISOString(),\n      status,\n      ...data,\n    })\n      // this properly formats objects and wraps strings in double quotes\n      .map(([key, value]) => `${key}=${JSON.stringify(value)}`)\n      .join(' ')\n  );\n}\n"],"names":["winston","require","HubLogger","options","sizeLimit","getSizeLimit","globalLabels","labels","consoleTransport","transports","Console","level","format","printf","data","message","handleExceptions","handleRejections","winstonLogger","createLogger","log","status","timestamp","Date","formatted","formatLog","Object","assign","length","warn","toISOString","slice","trim","lowerLimit","upperLimit","info","debug","error","dataOrError","Error","errorName","name","errorMessage","stack","source","getErrorSource","trace","filenameAndLineNumber","line","split","find","test","entries","map","key","value","JSON","stringify","join"],"mappings":";;;;;;;;;;;;;;;;;;;;;;AAAA;AACA,IAAMA,OAAO,gBAAGC,OAAO,CAAC,SAAD,CAAvB;;IAiCaC,SAAb;AAKE,qBAAYC,OAAZ;;;QAAYA;AAAAA,MAAAA,UAA6B;;;AACvC,SAAKC,SAAL,GAAiB,KAAKC,YAAL,CAAkBF,OAAO,CAACC,SAA1B,CAAjB;AACA,SAAKE,YAAL,sBAAoBH,OAAO,CAACI,MAA5B,8BAAsC,EAAtC;AAEA,QAAMC,gBAAgB,GAAG,IAAIR,OAAO,CAACS,UAAR,CAAmBC,OAAvB,CAA+B;AACtDC,MAAAA,KAAK,EAAER,OAAO,CAACQ,KAAR,IAAiB,MAD8B;AAEtDC,MAAAA,MAAM,EAAEZ,OAAO,CAACY,MAAR,CAAeC,MAAf,CACN,UAACC,IAAD;AAAA,eAA+BA,IAAI,CAACC,OAApC;AAAA,OADM,CAF8C;AAKtD;AACAC,MAAAA,gBAAgB,EAAE,IANoC;AAOtD;AACAC,MAAAA,gBAAgB,EAAE;AARoC,KAA/B,CAAzB;AAWA,SAAKC,aAAL,GAAqBlB,OAAO,CAACmB,YAAR,CAAqB;AACxCV,MAAAA,UAAU,EAAE,CAACD,gBAAD;AAD4B,KAArB,CAArB;AAGD;;AAvBH;;AAAA,SAyBUY,GAzBV,GAyBU,aAAIT,KAAJ,EAAqBU,MAArB,EAAqCP,IAArC;AACN,QAAMQ,SAAS,GAAG,IAAIC,IAAJ,EAAlB;AACA,QAAIC,SAAS,GAAWC,SAAS,CAC/Bd,KAD+B,EAE/BW,SAF+B,EAG/BD,MAH+B,EAI/BK,MAAM,CAACC,MAAP,CAAc,EAAd,EAAkB,KAAKrB,YAAvB,EAAqCQ,IAArC,CAJ+B,CAAjC;;AAOA,QAAIU,SAAS,CAACI,MAAV,GAAmB,KAAKxB,SAA5B,EAAuC;AACrC,WAAKyB,IAAL,CAAU,wBAAV,EAAoC;AAClCP,QAAAA,SAAS,EAAEA,SAAS,CAACQ,WAAV;AADuB,OAApC;AAIAN,MAAAA,SAAS,GAAG,yBAAsBA,SAAS,CAACO,KAAV,CAChC,CADgC,EAEhC,KAAK3B,SAF2B,CAAtB,EAGR4B,IAHQ,EAAZ;AAID;;AAED,SAAKd,aAAL,CAAmBP,KAAnB,EAA0Ba,SAA1B;AACD,GA9CH;;AAAA,SAgDUnB,YAhDV,GAgDU,sBAAcD,SAAd;;;AACN,QAAM6B,UAAU,GAAG,GAAnB;AACA,QAAMC,UAAU,GAAG,MAAM,IAAzB;;AAEA9B,IAAAA,SAAS,iBAAGA,SAAH,yBAAgB8B,UAAzB;;AAEA,QAAI9B,SAAS,GAAG6B,UAAhB,EAA4B;AAC1B;AACA,aAAOA,UAAP;AACD,KAHD,MAGO,IAAI7B,SAAS,GAAG8B,UAAhB,EAA4B;AACjC;AACA,aAAOA,UAAP;AACD,KAHM,MAGA;AACL,aAAO9B,SAAP;AACD;AACF;AAED;;;;;AAjEF;;AAAA,SAsEE+B,IAtEF,GAsEE,cAAKd,MAAL,EAAqBP,IAArB;AACE,SAAKM,GAAL,CAAS,MAAT,EAAiBC,MAAjB,EAAyBP,IAAzB;AACD;AAED;;;;;AA1EF;;AAAA,SA+EEsB,KA/EF,GA+EE,eAAMf,MAAN,EAAsBP,IAAtB;AACE,SAAKM,GAAL,CAAS,OAAT,EAAkBC,MAAlB,EAA0BP,IAA1B;AACD;AAED;;;;;AAnFF;;AAAA,SAwFEe,IAxFF,GAwFE,cAAKR,MAAL,EAAqBP,IAArB;AACE,SAAKM,GAAL,CAAS,MAAT,EAAiBC,MAAjB,EAAyBP,IAAzB;AACD;AAED;;;;;AA5FF;;AAAA,SAiGEuB,KAjGF,GAiGE,eAAMhB,MAAN,EAAsBiB,WAAtB;AACE,QAAIxB,IAAJ;;AAEA,QAAIwB,WAAW,YAAYC,KAA3B,EAAkC;AAChC,UAAMF,KAAK,GAAGC,WAAd;AAEAxB,MAAAA,IAAI,GAAG;AACL0B,QAAAA,SAAS,EAAEH,KAAK,CAACI,IADZ;AAELC,QAAAA,YAAY,EAAEL,KAAK,CAACtB;AAFf,OAAP;;AAKA,UAAIsB,KAAK,CAACM,KAAV,EAAiB;AACf7B,QAAAA,IAAI,CAAC8B,MAAL,GAAcC,cAAc,CAACR,KAAK,CAACM,KAAP,CAA5B;AACD;AACF,KAXD,MAWO;AACL7B,MAAAA,IAAI,GAAGwB,WAAP;AACD;;AAED,SAAKlB,GAAL,CAAS,OAAT,EAAkBC,MAAlB,EAA0BP,IAA1B;AACD,GApHH;;AAAA;AAAA;AAuHA;;;;;;;SAMgB+B,eAAeC;MAAAA;AAAAA,IAAAA,QAAQ;;;AACrC,MAAMC,qBAAqB,GAAG,qBAA9B;AACA,MAAMC,IAAI,GACRF,KAAK,CAACG,KAAN,CAAY,IAAZ,EAAkBC,IAAlB,CAAuB,UAAAF,IAAI;AAAA,WAAID,qBAAqB,CAACI,IAAtB,CAA2BH,IAA3B,CAAJ;AAAA,GAA3B,KAAoE,EADtE;AAEA,SAAOA,IAAI,CAAChB,IAAL,EAAP;AACD;AAED;;;;;;;;;;;SAUgBP,UAAUd,OAAiBW,WAAiBD,QAAgBP;MAAAA;AAAAA,IAAAA,OAAgB;;;AAC1F,SACEY,MAAM,CAAC0B,OAAP;AACEzC,IAAAA,KAAK,EAALA,KADF;AAEEW,IAAAA,SAAS,EAAEA,SAAS,CAACQ,WAAV,EAFb;AAGET,IAAAA,MAAM,EAANA;AAHF,KAIKP,IAJL;AAAA,GAOGuC,GAPH,CAOO;AAAA,QAAEC,GAAF;AAAA,QAAOC,KAAP;AAAA,WAAqBD,GAArB,SAA4BE,IAAI,CAACC,SAAL,CAAeF,KAAf,CAA5B;AAAA,GAPP,EAQGG,IARH,CAQQ,GARR,CADF;AAWD;;;;;;"}